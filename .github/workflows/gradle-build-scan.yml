name: Upload Gradle build scans to ge.armeria.dev

on:
  workflow_run:
    workflows: [CI]
    types:
      - completed

env:
  LC_ALL: "en_US.UTF-8"
  BUILD_JDK_VERSION: "19"
  GRADLE_ENTERPRISE_ACCESS_KEY: ${{ secrets.GRADLE_ENTERPRISE_ACCESS_KEY }}
  RUN_ID: ${{ github.event.workflow_run.id }}
  COMMIT_SHA: ${{ github.event.workflow_run.head_sha }}
  GRADLE_ENTERPRISE_CACHE_USERNAME: ${{ secrets.GRADLE_ENTERPRISE_CACHE_USERNAME }}
  GRADLE_ENTERPRISE_CACHE_PASSWORD: ${{ secrets.GRADLE_ENTERPRISE_CACHE_PASSWORD }}
  # Used by Octokit
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  DOWNLOAD_DIR: build-scans/

jobs:
  upload-build-cache:
    runs-on: ${{ matrix.os }}
    timeout-minutes: 120
    strategy:
      fail-fast: false
      matrix:
        os: [ ubuntu-latest, macos-12, windows-latest ]
    steps:
      - uses: actions/checkout@v3

      - id: setup-build-jdk
        name: Set up build JDK ${{ env.BUILD_JDK_VERSION }}
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: ${{ env.BUILD_JDK_VERSION }}

      - name: Setup Gradle
        uses: gradle/gradle-build-action@v2

      - name: Build with Gradle
        run: |
          ./gradlew --no-daemon --stacktrace --build-cache :core:build \
          -PbuildJdkVersion=${{ env.BUILD_JDK_VERSION }} \
          -Pretry=true -PfailOnPassedAfterRetry=false \
          -Porg.gradle.java.installations.paths=${{ steps.setup-build-jdk.outputs.path }}
        shell: bash
