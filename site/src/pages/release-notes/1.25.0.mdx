---
date: 2023-08-15
---

## üåü New features

- We can easily get header by using `headers()` method #5106
- A user can now easily build a native image of an Armeria application. #5005
- Future works:
  - Configure our build pipieline to generate native image config for
    different platforms automatically (macOS, Linux epoll, Linux io_uring
    and Windows).
  - Use annotation processors rather than reflection for scanning
    annotations.
  - Add entries for Windows and Linux io_uring. #5005
- Users can deserialize non-OK JSON response like the following
```java
// WebClient
WebClient.of().prepare()
     .as(ResponseAs.blocking()
                   .andThen(res -> "Unexpected server error", res -> res.status().isServerError())
                   .andThen(res -> "missing header", res -> !res.headers().contains("x-header"))
                   .orElse(AggregatedHttpObject::contentUtf8))
     .execute();
// RestClient
final ResponseEntity<MyResponse> res =
        RestClient.of(server.httpUri()).get("/")
                  .execute(ResponseAs.blocking()
                                     .<MyResponse>andThenJson(MyError.class, res -> res.status().isClientError())
                                     .andThenJson(EmptyMessage.class, res -> res.status().isInformational())
                                     .orElseJson(MyMessage.class));
``` #4382 #5002
- You can now easily create a `StreamMessage` using a future. #4995
- Users can easily implement gRPC richer error model. This model enables servers to return and clients to consume additional error details expressed as one or more protobuf messages #4614 #4986
- Micrometer Observation instrumentation #4659 #4980
- Add WebSocketClient #4972
- Improved efficiency of RequestLog access by reducing redundant checks and computations Enhanced compatibility for Kotlin developers by enabling null-safe calls when accessing RequestLog properties #4956 #4966
- User can specify custom Distribution Config with builder #4781 #4829
- Armeria user can report a failure to circuit breaker with response duration, and determine whether to re-try with response duration. #4782 #4827
- add `keepAliveOnPing` option to client options #4794 #4806
- Users can deserialize non-OK JSON response like the following
```java
// WebClient
CompletableFuture<ResponseEntity<MyObject>> response =
    client.prepare()
          .get("/v1/items/1")
          .asJson(MyObject.class, HttpStatus.INTERNAL_SERVER_ERROR)
          .execute();
// RestClient
CompletableFuture<ResponseEntity<MyObject>> response = 
    client.get("/v1/items/1")
          .execute(MyObject.class, HttpStatus.INTERNAL_SERVER_ERROR)
``` #4382 #4412

## üìà Improvements

- Use fewer event loops when using `io_uring` as transport #5089
- More explicit/clear usage of build directory property in gradle scripts. #5082
- Better input/output caching for `thriftCompile` tasks. #5081
- More consistent inputs across gradle builds
Note: Although gradle suggests using the [following](https://docs.gradle.org/current/userguide/caching_java_projects.html#dealing_with_file_paths), I've decided against it due to an unnecessary dependency on the `build` directory #5055
- https://github.com/line/armeria/actions/runs/5607879620/job/15192453765 #5055
- Input caching is done properly from different locations for checkstyle tasks. #5053
- Better input caching for `docs-client` #5052
- Better input caching #5041
- More information on tests at the cost of slightly slower builds #5018
- Users can customize their not-found error responses. #4996
- The client redirects correctly even if a reverse proxy rewrites the path. #4994
- Example URL: http://127.0.0.1:9000/proxy/docs/#/methods/armeria.grpc.testing.TestService/UnaryCallWithAllDifferentParameterTypes/POST Previously it sent requests to http://127.0.0.1:9000/test/armeria.grpc.testing.TestService/UnaryCallWithAllDifferentParameterTypes but in reality it should be URL: http://127.0.0.1:9000/proxy/test/armeria.grpc.testing.TestService/UnaryCallWithAllDifferentParameterTypes Because `DocService` is bound under `/docs` not `/proxy/docs`. To emulate, you can create the following proxy service: ```kotlin     sb         .virtualHost(9000)         .serviceUnder("/proxy/", ProxyService()) // Under ProxyService class ProxyService(val config: ProxyConfiguration) : HttpService {     override fun serve(ctx: ServiceRequestContext, req: HttpRequest): HttpResponse {         val r2 = req.mapHeaders { headers -> headers.toBuilder().path(req.path().replace("/proxy", "")).build() }         return client.execute(r2) // WebClient     } } ``` #4987
- Fix various `docs-client` interface issues #4983
- Replace `embedded-consul` with Testcontainers Hashicorp Consul module #4936 #4970
- You can now publish body and `HTTP trailers` easily by using `SurroundingPublisher` #3959 #4727

## üõ†Ô∏è Bug fixes

- Tests for Multi-release JAR now correctly run with `testJava9` and `testJava12` tasks. #5113
- Fixed a bug where headers could be written twice if `content-length` was exceeded during HTTP/2 cleartext upgrade. #5113
- Fix incorrect local and remote address when using domain socket in abstract namespace #5096
- `RequestScopedMdc` is now compatible with Logback 1.4.8 #5045 #5079
- Add `armeria-logback13` module to support compatibility for logback 1.3 #5078 #5077
- You can now use either an inline debug form or a debug form modal when using `DocService`. #5072
- Code coverage is correctly reported by Codecov. #5061
- You no longer see `kevent(..) Invalid Argument` when testing Armeria on macOS. #5061
- Even if internal-services.port and management.server.port are set to the same value, internal services are bound to the port only once. #4796 #5022
- Exceptions that occurred during a TLS handshake are properly propagated to users. #4950
- If the specified charset and the charset of the content-type header do not correspond, the content is decoded using the charset of the content type. This PR resolve issue #4931  #4948
- Routes with dynamic predicates are not cached #4927 #4934

## üìÉ Documentation

- People who read this document will be able to know in detail how to integrate to Spring Boot #4670 #4957
- The document can help developers to modify default properties or test more easily. #4870

## üèöÔ∏è Deprecations

- `HttpResponse.from(CompletionStage)` and its variants methods are deprecated.
  - Use `HttpResponse.of(CompletionStage)` and its variants instead. #5075

## ‚ò¢Ô∏è Breaking changes

- N/A

## ‚õì Dependencies

Better compatibility with `logback`
<img width="290" alt="image" src="https://github.com/line/armeria/assets/54794500/404059cc-3377-40b9-9b76-848ccf1135ac">

Latest Netty version

## üóë Maybe ignore

- Migrated to JUnit 5 --- Hi, I'm trying to work on a JUnit 4 -> 5 migration. ~It's going to take some time to migrate all tests, so I'd like to make it as draft and going to open it when it's done, is that ok?~ -> I'm working on a separate branch :) #5105
- Easier to understand the `CompileThriftTask` configuration and execution. #5098
- Better code separation between task configuration and task execution. #5098
- Prepared for easier possible refactoring away from using `project.ext` block in favor of configuring the task deterministically. #5098
- Use fewer event loops when using `io_uring` as transport #5089
- Set NVM dir correctly for post release process #5073
- Cleaner gradle code #5060
- Easier gradle task input caching since an absolute path to the agent jar isn't used. #5060
- It's much easier to distinguish the resources and classes in the test scope. #5057
- Less flaky tests #5042
- Migrate to JUnit 5 from JUnit 4 in related to `spring` module #4788 #5036
- Reformat `FlagsProviderTest` #5027
- Update foojay toolchain resolver plugin to 0.6.0 #5026
- Fix a failure in `TrailingDotAddressResolverTest` #5025
- Migrate some JUnit 4 tests to JUnit 5 #5024
- Cleaner code #5023
- Reduce CI failures #4984
- More stable CIs #4969
- You can now publish body and `HTTP trailers` easily by using `SurroundingPublisher` #3959 #4727

## üôá Thank you

<ThankYou usernames={[
  'CNJingo',
  'Dogacel',
  'KarboniteKream',
  'Kyoungwoong',
  'anuraaga',
  'babjo',
  'ceki',
  'chrisryan10',
  'echo304',
  'ghkim3221',
  'heowc',
  'hyperxpro',
  'ikhoon',
  'injae-kim',
  'jrhee17',
  'marcingrzejszczak',
  'minwoox',
  'mscheong01',
  'my4-dev',
  'mynameisjwlee',
  'r3mariano',
  'ribafish',
  'sh-cho',
  'ta7uw',
  'tomatophobia',
  'trustin',
  'wreulicke',
  'yunjoopark'
]} />